<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprimorador de Textos com IA</title>
    <script>
        // Suprimir warning do Tailwind CDN ANTES de carregar o Tailwind
        window.process = window.process || {};
        window.process.env = window.process.env || {};
        window.process.env.NODE_ENV = 'production';
        
        // Filtrar warnings do console
        const originalWarn = console.warn;
        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('cdn.tailwindcss.com') || 
                message.includes('Tailwind') || 
                message.includes('PostCSS')) {
                return; // Ignora warnings do Tailwind
            }
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4A49B0',
                    }
                }
            }
        }

        // Detectar modo escuro
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <style>
        .text-spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 0.2em solid rgba(93, 92, 222, 0.3);
            border-top-color: #5D5CDE;
            border-radius: 50%;
            animation: spinner 1s linear infinite;
        }
        
        .dark .text-spinner {
            border-color: rgba(93, 92, 222, 0.3);
            border-top-color: #5D5CDE;
        }
        
        @keyframes spinner {
            to {transform: rotate(360deg);}
        }

        .model-response {
            max-height: 300px;
            overflow-y: auto;
        }

        .model-response h1, .model-response h2, .model-response h3 {
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .model-response h1 {
            font-size: 1.5rem;
        }

        .model-response h2 {
            font-size: 1.25rem;
        }

        .model-response h3 {
            font-size: 1.1rem;
        }

        .model-response p {
            margin-bottom: 0.75rem;
        }

        .model-response ul, .model-response ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .model-response ul {
            list-style-type: disc;
        }

        .model-response ol {
            list-style-type: decimal;
        }

        .model-response li {
            margin-bottom: 0.25rem;
        }

        .model-response pre, .model-response code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.2rem;
            border-radius: 0.25rem;
        }

        .dark .model-response pre, .dark .model-response code {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .model-response blockquote {
            border-left: 3px solid #d1d5db;
            padding-left: 1rem;
            font-style: italic;
            margin: 0.75rem 0;
        }

        .dark .model-response blockquote {
            border-left-color: #4b5563;
        }
    </style>
</head>
<body class="min-h-screen bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-200">
    <div class="container mx-auto p-4 max-w-5xl">
        <h1 class="text-3xl font-bold text-center text-primary mb-6 mt-4">‚ú® Aprimorador de Textos com IA</h1>
        
        <!-- Se√ß√£o de Configura√ß√£o de API Keys -->
        <section id="section-api-config" class="mb-8 p-6 bg-blue-50 dark:bg-blue-900 rounded-lg border border-blue-200 dark:border-blue-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">‚öôÔ∏è Configura√ß√£o da API</h2>
                <button id="btn-toggle-config" class="px-3 py-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                    Expandir
                </button>
            </div>
            
            <div id="api-config-content" class="hidden">
                <p class="mb-4 text-sm">Configure sua chave de API do OpenRouter para usar todos os 4 modelos de IA. A chave √© armazenada apenas no seu navegador e nunca √© enviada para outros servidores.</p>
                
                <div class="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 mb-4">
                    <div class="flex items-center mb-2">
                        <span class="text-lg mr-2">üîë</span>
                        <h3 class="font-medium">OpenRouter API Key</h3>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Uma √∫nica chave para acessar Claude, GPT, Gemini e DeepSeek</p>
                    <input 
                        type="password" 
                        id="openrouter-api-key" 
                        placeholder="sk-or-..." 
                        class="w-full p-2 mb-2 text-sm border rounded bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"
                    >
                    <a href="https://openrouter.ai/keys" target="_blank" class="text-xs text-blue-500 hover:underline">
                        Obter chave gratuita no OpenRouter ‚Üí
                    </a>
                    <div class="mt-2">
                        <span id="openrouter-api-status" class="text-red-500 text-sm">‚úó N√£o configurado</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded">
                    <div class="text-center">
                        <span class="text-2xl">üîµ</span>
                        <p class="text-xs mt-1">Claude Sonnet 4</p>
                    </div>
                    <div class="text-center">
                        <span class="text-2xl">üü¢</span>
                        <p class="text-xs mt-1">GPT-4o Mini</p>
                    </div>
                    <div class="text-center">
                        <span class="text-2xl">üî¥</span>
                        <p class="text-xs mt-1">Gemini Flash</p>
                    </div>
                    <div class="text-center">
                        <span class="text-2xl">üü£</span>
                        <p class="text-xs mt-1">DeepSeek V3</p>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2">
                    <button id="btn-save-keys" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg transition-colors">
                        üíæ Salvar Configura√ß√£o
                    </button>
                    <button id="btn-clear-keys" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg transition-colors">
                        üóëÔ∏è Limpar Chave
                    </button>
                    <button id="btn-test-keys" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg transition-colors">
                        üß™ Testar API
                    </button>
                </div>

                <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900 rounded border border-yellow-200 dark:border-yellow-700">
                    <p class="text-xs text-yellow-800 dark:text-yellow-200">
                        <strong>üí° Por que OpenRouter?</strong> O OpenRouter oferece acesso unificado a m√∫ltiplos modelos de IA atrav√©s de uma √∫nica API. 
                        Voc√™ pode come√ßar gratuitamente e s√≥ paga pelo que usar. Sua chave √© armazenada localmente no navegador.
                    </p>
                </div>
            </div>
        </section>
        
        <!-- Etapas do processo -->
        <div class="mb-8">
            <div class="flex flex-wrap justify-between gap-2">
                <div id="step1" class="flex-1 p-2 text-center rounded-lg bg-primary text-white font-medium">1. Submeter Texto</div>
                <div id="step2" class="flex-1 p-2 text-center rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-medium">2. Confirmar Tipo</div>
                <div id="step3" class="flex-1 p-2 text-center rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-medium">3. An√°lise Inicial</div>
                <div id="step4" class="flex-1 p-2 text-center rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-medium">4. Sugest√µes</div>
                <div id="step5" class="flex-1 p-2 text-center rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-medium">5. Compara√ß√£o</div>
            </div>
        </div>
        
        <!-- Se√ß√£o 1: Envio do texto -->
        <section id="section-submit" class="mb-8">
            <div class="mb-4">
                <label for="text-input" class="block text-lg font-medium mb-2">Cole seu texto abaixo:</label>
                <textarea id="text-input" class="w-full p-3 border rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white border-gray-300 dark:border-gray-600 focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" rows="8" placeholder="Cole aqui o texto que deseja melhorar..."></textarea>
            </div>
            <button id="btn-analyze" class="w-full md:w-auto px-6 py-3 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                Analisar Texto
            </button>
            <p id="error-message" class="mt-2 text-red-500 hidden">Por favor, insira um texto para analisar.</p>
        </section>
        
        <!-- Se√ß√£o 2: Confirma√ß√£o de tipo de texto -->
        <section id="section-confirm-type" class="mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4">Confirme o tipo do seu texto:</h2>
            <div id="text-type-loader" class="flex items-center mb-4">
                <span class="text-spinner mr-2"></span>
                <span>Analisando o tipo de texto...</span>
            </div>
            <div id="text-type-result" class="hidden">
                <p class="mb-2">Parece que seu texto √© do tipo: <span id="detected-type" class="font-semibold"></span></p>
                <p class="mb-4">Este tipo √© correto?</p>
                <div class="flex flex-wrap gap-2">
                    <button id="btn-type-yes" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg transition-colors">
                        Sim, est√° correto
                    </button>
                    <button id="btn-type-no" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors">
                        N√£o, escolher outro
                    </button>
                </div>
                <div id="type-selection" class="mt-4 hidden">
                    <p class="mb-2">Selecione o tipo correto:</p>
                    <select id="text-type-select" class="w-full p-2 border rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white border-gray-300 dark:border-gray-600 text-base">
                        <option value="jornalistico">Jornal√≠stico</option>
                        <option value="academico">Acad√™mico/Cient√≠fico</option>
                        <option value="criativo">Criativo/Liter√°rio</option>
                        <option value="tecnico">T√©cnico/Profissional</option>
                        <option value="comercial">Comercial/Marketing</option>
                        <option value="informal">Informal/Blog</option>
                        <option value="outro">Outro</option>
                    </select>
                    <div id="other-type-container" class="mt-2 hidden">
                        <input id="other-type-input" type="text" class="w-full p-2 border rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white border-gray-300 dark:border-gray-600 text-base" placeholder="Especifique o tipo de texto...">
                    </div>
                    <button id="btn-type-confirm" class="mt-3 px-4 py-2 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors">
                        Confirmar
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Se√ß√£o 3: An√°lise inicial -->
        <section id="section-initial-analysis" class="mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4">An√°lise Inicial</h2>
            <div id="initial-analysis-loader" class="flex items-center mb-4">
                <span class="text-spinner mr-2"></span>
                <span>Analisando seu texto...</span>
            </div>
            <div id="initial-analysis-result" class="hidden">
                <div class="mb-4 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <p id="analysis-summary" class="mb-3"></p>
                    <h3 class="font-medium mb-2">Pontos fortes do seu texto:</h3>
                    <ul id="analysis-strengths" class="list-disc ml-4">
                        <!-- Pontos fortes ser√£o inseridos aqui -->
                    </ul>
                </div>
                <div class="mt-4">
                    <p class="mb-3">Voc√™ gostaria de solicitar alguma corre√ß√£o ou melhoria espec√≠fica?</p>
                    <textarea id="user-feedback" class="w-full p-3 border rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white border-gray-300 dark:border-gray-600 focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-base" rows="3" placeholder="Por exemplo: 'Melhorar a fluidez entre par√°grafos', 'Tornar mais formal', 'Encurtar introdu√ß√£o'..."></textarea>
                    <button id="btn-continue-feedback" class="mt-3 px-4 py-2 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors">
                        Continuar
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Se√ß√£o 4: Pontos fracos e gera√ß√£o de sugest√µes -->
        <section id="section-weaknesses" class="mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4">Pontos a Melhorar</h2>
            <div id="weaknesses-loader" class="flex items-center mb-4">
                <span class="text-spinner mr-2"></span>
                <span>Identificando oportunidades de melhoria...</span>
            </div>
            <div id="weaknesses-result" class="hidden">
                <div class="mb-4 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <h3 class="font-medium mb-2">Oportunidades de melhoria:</h3>
                    <ul id="text-weaknesses" class="list-disc ml-4">
                        <!-- Pontos fracos ser√£o inseridos aqui -->
                    </ul>
                </div>
                <div id="prompt-preview" class="mb-4 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <h3 class="font-medium mb-2">Prompt de melhoria gerado:</h3>
                    <p id="improvement-prompt" class="text-sm italic"></p>
                </div>
                <button id="btn-generate-suggestions" class="mt-3 px-4 py-2 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors">
                    Gerar Sugest√µes
                </button>
            </div>
        </section>
        
        <!-- Se√ß√£o 5: Visualiza√ß√£o das respostas dos modelos -->
        <section id="section-models-responses" class="mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4">An√°lise dos Modelos</h2>
            <div id="models-loading" class="mb-4">
                <p class="mb-2">Consultando modelos de IA para obter sugest√µes...</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Cont√™ineres para os modelos e suas respostas -->
                    <div class="p-4 border rounded-lg bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium">Claude Sonnet 4</h3>
                            <div id="claude-status" class="flex items-center">
                                <span class="text-spinner mr-2"></span>
                                <span class="text-sm">Gerando...</span>
                            </div>
                        </div>
                        <div id="claude-response" class="model-response prose dark:prose-invert prose-sm"></div>
                    </div>
                    
                    <div class="p-4 border rounded-lg bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium">GPT-4o Mini</h3>
                            <div id="gpt-status" class="flex items-center">
                                <span class="text-spinner mr-2"></span>
                                <span class="text-sm">Gerando...</span>
                            </div>
                        </div>
                        <div id="gpt-response" class="model-response prose dark:prose-invert prose-sm"></div>
                    </div>

                    <div class="p-4 border rounded-lg bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium">Gemini 2.0 Flash</h3>
                            <div id="gemini-status" class="flex items-center">
                                <span class="text-spinner mr-2"></span>
                                <span class="text-sm">Gerando...</span>
                            </div>
                        </div>
                        <div id="gemini-response" class="model-response prose dark:prose-invert prose-sm"></div>
                    </div>

                    <div class="p-4 border rounded-lg bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium">DeepSeek V3</h3>
                            <div id="deepseek-status" class="flex items-center">
                                <span class="text-spinner mr-2"></span>
                                <span class="text-sm">Gerando...</span>
                            </div>
                        </div>
                        <div id="deepseek-response" class="model-response prose dark:prose-invert prose-sm"></div>
                    </div>
                </div>
                <button id="btn-proceed-ranking" class="mt-4 px-4 py-2 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors hidden">
                    Comparar Resultados
                </button>
            </div>
        </section>
        
        <!-- Se√ß√£o 6: Ranqueamento e escolha final -->
        <section id="section-ranking" class="mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4">Compara√ß√£o dos Resultados</h2>
            <div id="ranking-loader" class="flex items-center mb-4">
                <span class="text-spinner mr-2"></span>
                <span>Avaliando as sugest√µes...</span>
            </div>
            <div id="ranking-result" class="hidden">
                <div class="mb-4 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <h3 class="font-medium mb-2">Classifica√ß√£o das sugest√µes:</h3>
                    <ul id="model-ranking" class="space-y-2">
                        <!-- Ranking ser√° inserido aqui -->
                    </ul>
                </div>
                <div id="selection-options" class="mt-4">
                    <p class="mb-3">Escolha uma op√ß√£o:</p>
                    <div class="space-y-2">
                        <button id="btn-select-best" class="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg transition-colors">
                            Selecionar a melhor sugest√£o
                        </button>
                        <button id="btn-select-combined" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg transition-colors">
                            Usar vers√£o combinada
                        </button>
                        <button id="btn-keep-original" class="w-full px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors">
                            Manter o texto original
                        </button>
                        <button id="btn-regenerate" class="w-full px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-medium rounded-lg transition-colors">
                            Gerar novo prompt de melhoria
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Se√ß√£o 7: Resultado final -->
        <section id="section-final-result" class="mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4">Texto Final</h2>
            <div class="mb-4 p-4 bg-white dark:bg-gray-800 border rounded-lg border-gray-300 dark:border-gray-600">
                <div id="final-text" class="whitespace-pre-wrap"></div>
            </div>
            <div class="flex flex-wrap gap-2">
                <button id="btn-copy-final" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors">
                    Copiar texto
                </button>
                <button id="btn-new-improvement" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors">
                    Continuar melhorando
                </button>
                <button id="btn-start-over" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg transition-colors">
                    Recome√ßar com novo texto
                </button>
            </div>
        </section>
        
        <!-- Mensagem de finaliza√ß√£o -->
        <div id="completion-message" class="text-center p-4 mt-8 hidden">
            <p class="text-lg font-medium text-green-600 dark:text-green-400">üéâ Parab√©ns! Seu texto foi melhorado com sucesso.</p>
        </div>
    </div>

    <script>
        // Estado global do aplicativo
        const appState = {
            originalText: '',
            textType: '',
            analysisStrengths: [],
            analysisSummary: '',
            userFeedback: '',
            textWeaknesses: [],
            improvementPrompt: '',
            modelResponses: {
                claude: { content: '', score: 0, status: 'pending' },
                gpt: { content: '', score: 0, status: 'pending' },
                gemini: { content: '', score: 0, status: 'pending' },
                deepseek: { content: '', score: 0, status: 'pending' }
            },
            combinedResponse: '',
            ranking: [],
            finalText: '',
            currentStep: 1,
            apiKeys: {
                openrouter: ''
            }
        };

        // Elementos da interface
        const elements = {
            sections: {
                submit: document.getElementById('section-submit'),
                confirmType: document.getElementById('section-confirm-type'),
                initialAnalysis: document.getElementById('section-initial-analysis'),
                weaknesses: document.getElementById('section-weaknesses'),
                modelsResponses: document.getElementById('section-models-responses'),
                ranking: document.getElementById('section-ranking'),
                finalResult: document.getElementById('section-final-result')
            },
            steps: {
                step1: document.getElementById('step1'),
                step2: document.getElementById('step2'),
                step3: document.getElementById('step3'),
                step4: document.getElementById('step4'),
                step5: document.getElementById('step5')
            },
            // API Configuration
            btnToggleConfig: document.getElementById('btn-toggle-config'),
            apiConfigContent: document.getElementById('api-config-content'),
            openrouterApiKey: document.getElementById('openrouter-api-key'),
            btnSaveKeys: document.getElementById('btn-save-keys'),
            btnClearKeys: document.getElementById('btn-clear-keys'),
            btnTestKeys: document.getElementById('btn-test-keys'),
            openrouterApiStatus: document.getElementById('openrouter-api-status'),
            // Main interface elements
            textInput: document.getElementById('text-input'),
            btnAnalyze: document.getElementById('btn-analyze'),
            errorMessage: document.getElementById('error-message'),
            textTypeLoader: document.getElementById('text-type-loader'),
            textTypeResult: document.getElementById('text-type-result'),
            detectedType: document.getElementById('detected-type'),
            btnTypeYes: document.getElementById('btn-type-yes'),
            btnTypeNo: document.getElementById('btn-type-no'),
            typeSelection: document.getElementById('type-selection'),
            textTypeSelect: document.getElementById('text-type-select'),
            otherTypeContainer: document.getElementById('other-type-container'),
            otherTypeInput: document.getElementById('other-type-input'),
            btnTypeConfirm: document.getElementById('btn-type-confirm'),
            initialAnalysisLoader: document.getElementById('initial-analysis-loader'),
            initialAnalysisResult: document.getElementById('initial-analysis-result'),
            analysisSummary: document.getElementById('analysis-summary'),
            analysisStrengths: document.getElementById('analysis-strengths'),
            userFeedback: document.getElementById('user-feedback'),
            btnContinueFeedback: document.getElementById('btn-continue-feedback'),
            weaknessesLoader: document.getElementById('weaknesses-loader'),
            weaknessesResult: document.getElementById('weaknesses-result'),
            textWeaknesses: document.getElementById('text-weaknesses'),
            improvementPrompt: document.getElementById('improvement-prompt'),
            btnGenerateSuggestions: document.getElementById('btn-generate-suggestions'),
            modelsLoading: document.getElementById('models-loading'),
            claudeStatus: document.getElementById('claude-status'),
            gptStatus: document.getElementById('gpt-status'),
            geminiStatus: document.getElementById('gemini-status'),
            deepseekStatus: document.getElementById('deepseek-status'),
            claudeResponse: document.getElementById('claude-response'),
            gptResponse: document.getElementById('gpt-response'),
            geminiResponse: document.getElementById('gemini-response'),
            deepseekResponse: document.getElementById('deepseek-response'),
            btnProceedRanking: document.getElementById('btn-proceed-ranking'),
            rankingLoader: document.getElementById('ranking-loader'),
            rankingResult: document.getElementById('ranking-result'),
            modelRanking: document.getElementById('model-ranking'),
            btnSelectBest: document.getElementById('btn-select-best'),
            btnSelectCombined: document.getElementById('btn-select-combined'),
            btnKeepOriginal: document.getElementById('btn-keep-original'),
            btnRegenerate: document.getElementById('btn-regenerate'),
            finalText: document.getElementById('final-text'),
            btnCopyFinal: document.getElementById('btn-copy-final'),
            btnNewImprovement: document.getElementById('btn-new-improvement'),
            btnStartOver: document.getElementById('btn-start-over'),
            completionMessage: document.getElementById('completion-message')
        };

        // ===== FUN√á√ïES DE GERENCIAMENTO DE API KEYS =====
        
        // Carregar chaves de API do localStorage
        function loadAPIKeys() {
            const savedKeys = localStorage.getItem('aiTextImprover_apiKeys');
            if (savedKeys) {
                try {
                    const keys = JSON.parse(savedKeys);
                    
                    // Atualizar o estado
                    appState.apiKeys.openrouter = keys.openrouter || '';
                    
                    // Preencher o campo
                    if (keys.openrouter) elements.openrouterApiKey.value = keys.openrouter;
                    
                    // Atualizar status
                    updateAPIStatus();
                } catch (err) {
                    console.error('Erro ao carregar chaves:', err);
                }
            }
        }

        // Salvar chaves de API no localStorage
        function saveAPIKeys() {
            const key = elements.openrouterApiKey.value.trim();
            
            // Salvar no estado imediatamente
            appState.apiKeys.openrouter = key;
            
            // Salvar no localStorage
            localStorage.setItem('aiTextImprover_apiKeys', JSON.stringify({ openrouter: key }));
            updateAPIStatus();
            
            alert('‚úì Configura√ß√£o salva com sucesso!');
        }

        // Limpar todas as chaves
        function clearAPIKeys() {
            if (confirm('Tem certeza que deseja limpar a chave de API?')) {
                localStorage.removeItem('aiTextImprover_apiKeys');
                appState.apiKeys.openrouter = '';
                elements.openrouterApiKey.value = '';
                updateAPIStatus();
                alert('‚úì Chave removida.');
            }
        }

        // Atualizar status visual das APIs
        function updateAPIStatus() {
            if (appState.apiKeys.openrouter && appState.apiKeys.openrouter.length > 10) {
                elements.openrouterApiStatus.innerHTML = '<span class="text-green-500">‚úì Configurado</span>';
            } else {
                elements.openrouterApiStatus.innerHTML = '<span class="text-red-500">‚úó N√£o configurado</span>';
            }
        }

        // Testar todas as APIs configuradas
        async function testAPIKeys() {
            if (!appState.apiKeys.openrouter || appState.apiKeys.openrouter.length < 10) {
                alert('‚ö†Ô∏è Por favor, configure a chave do OpenRouter primeiro.');
                return;
            }

            const testPrompt = "Diga apenas 'OK' se voc√™ puder me entender.";
            let results = [];
            
            elements.btnTestKeys.disabled = true;
            elements.btnTestKeys.textContent = 'üß™ Testando...';
            
            // Testar Claude via OpenRouter
            try {
                const claudeResult = await callOpenRouterAPI(testPrompt, 'anthropic/claude-3.5-sonnet');
                if (claudeResult && claudeResult.length > 0) {
                    results.push('‚úì Claude Sonnet 4: Funcionando corretamente');
                } else {
                    results.push('‚úó Claude: Resposta vazia');
                }
            } catch (err) {
                console.error('Erro no teste do Claude:', err);
                results.push('‚úó Claude: ' + (err.message || 'Erro desconhecido'));
            }
            
            // Testar GPT via OpenRouter
            try {
                const gptResult = await callOpenRouterAPI(testPrompt, 'openai/gpt-4o-mini');
                if (gptResult && gptResult.length > 0) {
                    results.push('‚úì GPT-4o Mini: Funcionando corretamente');
                } else {
                    results.push('‚úó GPT: Resposta vazia');
                }
            } catch (err) {
                console.error('Erro no teste do GPT:', err);
                const errorMsg = err.message || 'Erro desconhecido';
                results.push('‚úó GPT: ' + errorMsg);
            }
            
            // Testar Gemini via OpenRouter
            try {
                const geminiResult = await callOpenRouterAPI(testPrompt, 'google/gemini-2.0-flash-001');
                if (geminiResult && geminiResult.length > 0) {
                    results.push('‚úì Gemini 2.0 Flash: Funcionando corretamente');
                } else {
                    results.push('‚úó Gemini: Resposta vazia');
                }
            } catch (err) {
                console.error('Erro no teste do Gemini:', err);
                const errorMsg = err.message || 'Erro desconhecido';
                results.push('‚úó Gemini: ' + errorMsg);
            }
            
            // Testar DeepSeek via OpenRouter
            try {
                const deepseekResult = await callOpenRouterAPI(testPrompt, 'deepseek/deepseek-chat');
                if (deepseekResult && deepseekResult.length > 0) {
                    results.push('‚úì DeepSeek V3: Funcionando corretamente');
                } else {
                    results.push('‚úó DeepSeek: Resposta vazia');
                }
            } catch (err) {
                console.error('Erro no teste do DeepSeek:', err);
                results.push('‚úó DeepSeek: ' + (err.message || 'Erro'));
            }
            
            elements.btnTestKeys.disabled = false;
            elements.btnTestKeys.textContent = 'üß™ Testar API';
            
            // Criar um modal melhor para mostrar os resultados
            const resultHTML = `
                <div style="text-align: left; font-family: monospace;">
                    <h3 style="margin-bottom: 10px; font-weight: bold; color: #333;">Resultados dos Testes:</h3>
                    ${results.map(r => {
                        let bgColor, textColor;
                        if (r.startsWith('‚úì')) {
                            bgColor = '#d4edda';
                            textColor = '#155724';
                        } else if (r.startsWith('‚úó')) {
                            bgColor = '#f8d7da';
                            textColor = '#721c24';
                        } else {
                            bgColor = '#fff3cd';
                            textColor = '#856404';
                        }
                        return `<div style="margin: 5px 0; padding: 8px; background: ${bgColor}; color: ${textColor}; border-radius: 3px; font-weight: 500;">${r}</div>`;
                    }).join('')}
                </div>
            `;
            
            // Criar um div tempor√°rio para mostrar os resultados
            const resultDiv = document.createElement('div');
            resultDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 9999; max-width: 600px; min-width: 400px;';
            resultDiv.innerHTML = resultHTML + '<button id="close-result" style="margin-top: 15px; padding: 10px 20px; background: #5D5CDE; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Fechar</button>';
            
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9998;';
            
            document.body.appendChild(overlay);
            document.body.appendChild(resultDiv);
            
            document.getElementById('close-result').addEventListener('click', () => {
                document.body.removeChild(resultDiv);
                document.body.removeChild(overlay);
            });
            
            overlay.addEventListener('click', () => {
                document.body.removeChild(resultDiv);
                document.body.removeChild(overlay);
            });
        }

        // ===== FUN√á√ïES DE CHAMADA DE API =====
        
        // Fun√ß√£o unificada para chamar a API do OpenRouter
        async function callOpenRouterAPI(prompt, model) {
            if (!appState.apiKeys.openrouter) {
                throw new Error('Chave da API OpenRouter n√£o configurada');
            }
            
            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${appState.apiKeys.openrouter}`,
                        "HTTP-Referer": "https://aprimorador-textos.local",
                        "X-Title": "Aprimorador de Textos"
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: "user", content: prompt }
                        ],
                        max_tokens: 1200
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'Erro na API OpenRouter');
                }
                
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    return data.choices[0].message.content;
                } else {
                    throw new Error('Resposta inv√°lida da API OpenRouter');
                }
            } catch (error) {
                console.error('Erro ao chamar API OpenRouter:', error);
                
                // Tratamento de erros espec√≠ficos
                if (error.message.includes('Failed to fetch')) {
                    throw new Error('Erro de conex√£o. Verifique: 1) Sua conex√£o com a internet, 2) Se a chave API est√° correta, 3) Se voc√™ tem cr√©ditos no OpenRouter');
                }
                
                throw error;
            }
        }

        // Atualiza a visualiza√ß√£o da etapa atual
        function updateStepDisplay(step) {
            appState.currentStep = step;
            
            Object.values(elements.steps).forEach(stepEl => {
                stepEl.classList.remove('bg-primary', 'text-white');
                stepEl.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-500', 'dark:text-gray-400');
            });
            
            const currentStepEl = elements.steps[`step${step}`];
            if (currentStepEl) {
                currentStepEl.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-500', 'dark:text-gray-400');
                currentStepEl.classList.add('bg-primary', 'text-white');
            }
            
            Object.values(elements.sections).forEach(section => {
                section.classList.add('hidden');
            });
            
            switch (step) {
                case 1:
                    elements.sections.submit.classList.remove('hidden');
                    break;
                case 2:
                    elements.sections.confirmType.classList.remove('hidden');
                    break;
                case 3:
                    elements.sections.initialAnalysis.classList.remove('hidden');
                    break;
                case 4:
                    elements.sections.weaknesses.classList.remove('hidden');
                    elements.sections.modelsResponses.classList.remove('hidden');
                    break;
                case 5:
                    elements.sections.ranking.classList.remove('hidden');
                    elements.sections.finalResult.classList.remove('hidden');
                    break;
            }
        }

        // Detectar tipo de texto
        async function detectTextType() {
            try {
                elements.textTypeLoader.classList.remove('hidden');
                elements.textTypeResult.classList.add('hidden');
                
                const prompt = `Analise este texto e identifique qual √© o tipo dele (jornal√≠stico, cient√≠fico, criativo, t√©cnico, comercial etc). Responda APENAS com "O tipo do texto √©: [tipo]". Seja direto e conciso.

Texto: ${appState.originalText.substring(0, 1500)}`;
                
                const response = await callOpenRouterAPI(prompt, 'anthropic/claude-3.5-sonnet');
                
                const typeMatch = response.match(/tipo[^:]*:\s*([^\n.]+)/i);
                if (typeMatch && typeMatch[1]) {
                    appState.textType = typeMatch[1].trim();
                } else {
                    appState.textType = response.trim().replace(/O tipo do texto √©:\s*/i, '').split('.')[0];
                }
                
                elements.detectedType.textContent = appState.textType;
                elements.textTypeLoader.classList.add('hidden');
                elements.textTypeResult.classList.remove('hidden');
            } catch (err) {
                console.error("Erro ao detectar tipo de texto:", err);
                elements.textTypeLoader.classList.add('hidden');
                alert("Ocorreu um erro ao analisar o texto. Verifique se a chave da API est√° configurada.");
            }
        }

        // An√°lise inicial
        async function performInitialAnalysis() {
            try {
                elements.initialAnalysisLoader.classList.remove('hidden');
                elements.initialAnalysisResult.classList.add('hidden');
                
                const prompt = `Analise este texto do tipo ${appState.textType} e produza:
1. Um breve resumo de um par√°grafo sobre o texto
2. Uma lista com 5 pontos fortes do texto

Formate sua resposta EXATAMENTE assim:
[Seu resumo de um par√°grafo aqui]

Pontos fortes:
- [Ponto forte 1]
- [Ponto forte 2]
- [Ponto forte 3]
- [Ponto forte 4]
- [Ponto forte 5]

Texto: ${appState.originalText}`;
                
                const response = await callOpenRouterAPI(prompt, 'anthropic/claude-3.5-sonnet');
                
                const parts = response.split(/Pontos fortes:|Pontos positivos:/i);
                
                if (parts.length >= 2) {
                    appState.analysisSummary = parts[0].trim();
                    elements.analysisSummary.textContent = appState.analysisSummary;
                    
                    const strengthsText = parts[1].trim();
                    const strengthsList = strengthsText.split(/\n\s*[-‚Ä¢*]\s*/).filter(item => item.trim().length > 0);
                    
                    appState.analysisStrengths = strengthsList;
                    
                    elements.analysisStrengths.innerHTML = '';
                    strengthsList.forEach(strength => {
                        const li = document.createElement('li');
                        li.textContent = strength.trim();
                        elements.analysisStrengths.appendChild(li);
                    });
                    
                    elements.initialAnalysisLoader.classList.add('hidden');
                    elements.initialAnalysisResult.classList.remove('hidden');
                } else {
                    elements.analysisSummary.textContent = response;
                    elements.initialAnalysisLoader.classList.add('hidden');
                    elements.initialAnalysisResult.classList.remove('hidden');
                }
            } catch (err) {
                console.error("Erro na an√°lise inicial:", err);
                elements.initialAnalysisLoader.classList.add('hidden');
                alert("Ocorreu um erro ao analisar o texto. Verifique se a chave da API est√° configurada.");
            }
        }

        // Identificar pontos fracos
        async function identifyWeaknesses() {
            try {
                elements.weaknessesLoader.classList.remove('hidden');
                elements.weaknessesResult.classList.add('hidden');
                
                const userFeedback = elements.userFeedback.value.trim();
                appState.userFeedback = userFeedback;
                
                const prompt = `Analise este texto do tipo ${appState.textType} e identifique:
1. Uma lista com 3-5 pontos espec√≠ficos que podem ser melhorados
2. Um prompt detalhado que orientar√° melhorias no texto

Considere estas informa√ß√µes:
- Pontos fortes j√° identificados: ${appState.analysisStrengths.join(', ')}
- Feedback do usu√°rio: ${userFeedback || "Nenhum feedback espec√≠fico"}

Formate sua resposta EXATAMENTE assim:
Pontos a melhorar:
- [Ponto 1]
- [Ponto 2]
- [Ponto 3]

Prompt de melhoria:
[Seu prompt detalhado para melhorar o texto]

Texto: ${appState.originalText}`;
                
                const response = await callOpenRouterAPI(prompt, 'anthropic/claude-3.5-sonnet');
                
                const parts = response.split(/Prompt de melhoria:|Prompt sugerido:/i);
                let weaknessesText = '';
                let promptText = '';
                
                if (parts.length >= 2) {
                    weaknessesText = parts[0].trim();
                    promptText = parts[1].trim();
                    
                    const weaknessPart = weaknessesText.split(/Pontos a melhorar:|Oportunidades de melhoria:|Pontos fracos:/i);
                    if (weaknessPart.length >= 2) {
                        const weaknessList = weaknessPart[1].trim().split(/\n\s*[-‚Ä¢*]\s*/).filter(item => item.trim().length > 0);
                        
                        appState.textWeaknesses = weaknessList;
                        
                        elements.textWeaknesses.innerHTML = '';
                        weaknessList.forEach(weakness => {
                            const li = document.createElement('li');
                            li.textContent = weakness.trim();
                            elements.textWeaknesses.appendChild(li);
                        });
                    }
                    
                    appState.improvementPrompt = promptText;
                    elements.improvementPrompt.textContent = promptText;
                    
                    elements.weaknessesLoader.classList.add('hidden');
                    elements.weaknessesResult.classList.remove('hidden');
                } else {
                    elements.weaknessesLoader.classList.add('hidden');
                    elements.weaknessesResult.classList.remove('hidden');
                    appState.improvementPrompt = "Melhore este texto tornando-o mais claro, conciso e coerente.";
                    elements.improvementPrompt.textContent = appState.improvementPrompt;
                }
            } catch (err) {
                console.error("Erro ao identificar pontos fracos:", err);
                elements.weaknessesLoader.classList.add('hidden');
                alert("Ocorreu um erro ao identificar pontos de melhoria. Verifique se a chave da API est√° configurada.");
            }
        }

        // Gerar sugest√µes
        async function generateSuggestions() {
            if (!appState.apiKeys.openrouter || appState.apiKeys.openrouter.length < 10) {
                alert('‚ö†Ô∏è Por favor, configure a chave do OpenRouter na se√ß√£o de configura√ß√µes no topo da p√°gina.');
                return;
            }

            try {
                Object.keys(appState.modelResponses).forEach(key => {
                    appState.modelResponses[key] = { content: '', score: 0, status: 'pending' };
                });
                
                const promptPrefix = `Voc√™ √© um especialista em revis√£o e melhoria de textos do tipo ${appState.textType}. Melhore o texto abaixo conforme as instru√ß√µes:

${appState.improvementPrompt}

TEXTO ORIGINAL:
${appState.originalText}

TEXTO MELHORADO:`;
                
                // Claude Sonnet 4 via OpenRouter
                callOpenRouterAPI(promptPrefix, 'anthropic/claude-3.5-sonnet').then(response => {
                    appState.modelResponses.claude.content = response;
                    appState.modelResponses.claude.status = 'complete';
                    elements.claudeResponse.innerHTML = marked.parse(response);
                    elements.claudeStatus.innerHTML = '<span class="text-sm text-green-500">‚úì Completo</span>';
                    checkAllModelsComplete();
                }).catch(err => {
                    console.error('Erro no Claude:', err);
                    appState.modelResponses.claude.status = 'error';
                    elements.claudeStatus.innerHTML = '<span class="text-sm text-red-500">‚úó Erro</span>';
                    elements.claudeResponse.innerHTML = `<p class="text-red-500 text-sm">Erro: ${err.message}</p>`;
                    checkAllModelsComplete();
                });
                
                // GPT-4o Mini via OpenRouter
                callOpenRouterAPI(promptPrefix, 'openai/gpt-4o-mini').then(response => {
                    appState.modelResponses.gpt.content = response;
                    appState.modelResponses.gpt.status = 'complete';
                    elements.gptResponse.innerHTML = marked.parse(response);
                    elements.gptStatus.innerHTML = '<span class="text-sm text-green-500">‚úì Completo</span>';
                    checkAllModelsComplete();
                }).catch(err => {
                    console.error('Erro no GPT:', err);
                    appState.modelResponses.gpt.status = 'error';
                    elements.gptStatus.innerHTML = '<span class="text-sm text-red-500">‚úó Erro</span>';
                    elements.gptResponse.innerHTML = `<p class="text-red-500 text-sm">Erro: ${err.message}</p>`;
                    checkAllModelsComplete();
                });

                // Gemini 2.0 Flash via OpenRouter (free tier)
                callOpenRouterAPI(promptPrefix, 'google/gemini-2.0-flash-exp:free').then(response => {
                    appState.modelResponses.gemini.content = response;
                    appState.modelResponses.gemini.status = 'complete';
                    elements.geminiResponse.innerHTML = marked.parse(response);
                    elements.geminiStatus.innerHTML = '<span class="text-sm text-green-500">‚úì Completo</span>';
                    checkAllModelsComplete();
                }).catch(err => {
                    console.error('Erro no Gemini:', err);
                    appState.modelResponses.gemini.status = 'error';
                    elements.geminiStatus.innerHTML = '<span class="text-sm text-red-500">‚úó Erro</span>';
                    elements.geminiResponse.innerHTML = `<p class="text-red-500 text-sm">Erro: ${err.message}</p>`;
                    checkAllModelsComplete();
                });

                // DeepSeek V3 via OpenRouter
                callOpenRouterAPI(promptPrefix, 'deepseek/deepseek-chat').then(response => {
                    appState.modelResponses.deepseek.content = response;
                    appState.modelResponses.deepseek.status = 'complete';
                    elements.deepseekResponse.innerHTML = marked.parse(response);
                    elements.deepseekStatus.innerHTML = '<span class="text-sm text-green-500">‚úì Completo</span>';
                    checkAllModelsComplete();
                }).catch(err => {
                    console.error('Erro no DeepSeek:', err);
                    appState.modelResponses.deepseek.status = 'error';
                    elements.deepseekStatus.innerHTML = '<span class="text-sm text-red-500">‚úó Erro</span>';
                    elements.deepseekResponse.innerHTML = `<p class="text-red-500 text-sm">Erro: ${err.message}</p>`;
                    checkAllModelsComplete();
                });
            } catch (err) {
                console.error("Erro ao gerar sugest√µes:", err);
                alert("Ocorreu um erro ao gerar sugest√µes. Por favor, tente novamente.");
            }
        }

        // Verificar se todos os modelos completaram
        function checkAllModelsComplete() {
            const allComplete = 
                (appState.modelResponses.claude.status === "complete" || appState.modelResponses.claude.status === "error") &&
                (appState.modelResponses.gpt.status === "complete" || appState.modelResponses.gpt.status === "error") &&
                (appState.modelResponses.gemini.status === "complete" || appState.modelResponses.gemini.status === "error") &&
                (appState.modelResponses.deepseek.status === "complete" || appState.modelResponses.deepseek.status === "error");
            
            if (allComplete) {
                elements.btnProceedRanking.classList.remove('hidden');
            }
        }

        // Ranquear respostas
        async function rankModelResponses() {
            try {
                elements.rankingLoader.classList.remove('hidden');
                elements.rankingResult.classList.add('hidden');
                
                const modelOutputs = {};
                Object.entries(appState.modelResponses).forEach(([key, value]) => {
                    if (value.status === "complete" && value.content) {
                        const modelNames = {
                            'claude': 'Claude Sonnet 4',
                            'gpt': 'GPT-4o Mini',
                            'gemini': 'Gemini 2.0 Flash',
                            'deepseek': 'DeepSeek V3'
                        };
                        modelOutputs[modelNames[key] || key] = value.content;
                    }
                });
                
                if (Object.keys(modelOutputs).length === 0) {
                    elements.rankingLoader.classList.add('hidden');
                    alert("Nenhuma resposta completa foi gerada pelos modelos. Por favor, tente novamente.");
                    return;
                }
                
                const prompt = `Avalie as seguintes melhorias de texto geradas por diferentes modelos de IA. O texto original √© do tipo ${appState.textType}.

Texto original:
${appState.originalText}

${Object.entries(modelOutputs).map(([model, text]) => `Vers√£o do ${model}:
${text}
`).join('\n')}

Critique cada vers√£o com base em:
1. Clareza e fluidez
2. Manuten√ß√£o do estilo e tom originais
3. Resolu√ß√£o dos problemas identificados
4. Melhoria geral da qualidade

Para cada modelo, d√™ uma pontua√ß√£o de 0-10 e uma breve justificativa.

Em seguida, crie uma "Vers√£o combinada" que incorpore os melhores elementos de cada resposta.

Formate sua resposta EXATAMENTE assim:

Ranqueamento:
1. [Nome do modelo]: [Breve justificativa] (Pontua√ß√£o: X/10)
2. [Nome do modelo]: [Breve justificativa] (Pontua√ß√£o: X/10)

Vers√£o combinada:
[Texto combinado aqui]`;
                
                const response = await callClaudeAPI(prompt);
                
                // Processar ranqueamento
                const rankingMatch = response.match(/Ranqueamento:([\s\S]*?)(?:Vers√£o combinada:|$)/i);
                const combinedMatch = response.match(/Vers√£o combinada:([\s\S]*)/i);
                
                if (rankingMatch) {
                    const rankingText = rankingMatch[1].trim();
                    const rankItems = rankingText.split(/\n\s*\d+\.\s*/).filter(item => item.trim().length > 0);
                    
                    appState.ranking = rankItems.map((item, index) => {
                        const modelMatch = item.match(/^([^:]+):\s*([\s\S]*)/i);
                        if (modelMatch) {
                            const modelName = modelMatch[1].trim();
                            const modelDesc = modelMatch[2].trim();
                            
                            const scoreMatch = item.match(/pontua√ß√£o:\s*(\d+(?:\.\d+)?)\s*\/\s*10/i) ||
                                             item.match(/\((\d+(?:\.\d+)?)\s*\/\s*10\)/i);
                            const modelScore = scoreMatch ? parseFloat(scoreMatch[1]) : (10 - index * 1.5);
                            
                            let modelId = '';
                            if (modelName.toLowerCase().includes('claude') && modelName.toLowerCase().includes('sonnet')) modelId = 'claude';
                            else if (modelName.toLowerCase().includes('gpt') || modelName.toLowerCase().includes('chatgpt')) modelId = 'gpt';
                            else if (modelName.toLowerCase().includes('gemini')) modelId = 'gemini';
                            else if (modelName.toLowerCase().includes('deepseek')) modelId = 'deepseek';
                            
                            return {
                                id: modelId,
                                name: modelName,
                                description: modelDesc.replace(/\(.*?\)/g, '').trim(),
                                score: modelScore
                            };
                        }
                        return null;
                    }).filter(item => item !== null);
                    
                    appState.ranking.forEach(rank => {
                        if (appState.modelResponses[rank.id]) {
                            appState.modelResponses[rank.id].score = rank.score;
                        }
                    });
                    
                    elements.modelRanking.innerHTML = '';
                    appState.ranking.forEach((rank, index) => {
                        const li = document.createElement('li');
                        li.className = 'p-2 rounded-lg ' + 
                            (index === 0 ? 'bg-green-100 dark:bg-green-900' : 'bg-gray-50 dark:bg-gray-800');
                        
                        li.innerHTML = `
                            <div class="flex justify-between">
                                <span class="font-medium">${index + 1}. ${rank.name}</span>
                                <span class="text-sm ${index === 0 ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-400'}">
                                    Pontua√ß√£o: ${rank.score.toFixed(1)}/10
                                </span>
                            </div>
                            <p class="text-sm mt-1">${rank.description}</p>
                        `;
                        elements.modelRanking.appendChild(li);
                    });
                }
                
                if (combinedMatch) {
                    appState.combinedResponse = combinedMatch[1].trim();
                } else if (appState.ranking.length > 0) {
                    const bestModel = appState.ranking[0]?.id;
                    if (bestModel && appState.modelResponses[bestModel]) {
                        appState.combinedResponse = appState.modelResponses[bestModel].content;
                    }
                }
                
                elements.rankingLoader.classList.add('hidden');
                elements.rankingResult.classList.remove('hidden');
            } catch (err) {
                console.error("Erro ao ranquear respostas:", err);
                elements.rankingLoader.classList.add('hidden');
                alert("Ocorreu um erro ao comparar os resultados. Por favor, tente novamente.");
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar chaves salvas
            loadAPIKeys();
            
            // Toggle de configura√ß√£o de API
            elements.btnToggleConfig.addEventListener('click', () => {
                const isHidden = elements.apiConfigContent.classList.contains('hidden');
                if (isHidden) {
                    elements.apiConfigContent.classList.remove('hidden');
                    elements.btnToggleConfig.textContent = 'Recolher';
                } else {
                    elements.apiConfigContent.classList.add('hidden');
                    elements.btnToggleConfig.textContent = 'Expandir';
                }
            });
            
            // Salvar chaves
            elements.btnSaveKeys.addEventListener('click', saveAPIKeys);
            
            // Limpar chaves
            elements.btnClearKeys.addEventListener('click', clearAPIKeys);
            
            // Testar APIs
            elements.btnTestKeys.addEventListener('click', testAPIKeys);
            
            // Atualizar status quando o usu√°rio digita
            elements.openrouterApiKey.addEventListener('input', updateAPIStatus);
            
            // Iniciar na primeira etapa
            updateStepDisplay(1);
            
            elements.btnAnalyze.addEventListener('click', () => {
                const text = elements.textInput.value.trim();
                if (!text) {
                    elements.errorMessage.classList.remove('hidden');
                    return;
                }
                
                elements.errorMessage.classList.add('hidden');
                appState.originalText = text;
                updateStepDisplay(2);
                detectTextType();
            });
            
            elements.btnTypeYes.addEventListener('click', () => {
                updateStepDisplay(3);
                performInitialAnalysis();
            });
            
            elements.btnTypeNo.addEventListener('click', () => {
                elements.typeSelection.classList.remove('hidden');
            });
            
            elements.textTypeSelect.addEventListener('change', () => {
                const selectedType = elements.textTypeSelect.value;
                if (selectedType === 'outro') {
                    elements.otherTypeContainer.classList.remove('hidden');
                } else {
                    elements.otherTypeContainer.classList.add('hidden');
                }
            });
            
            elements.btnTypeConfirm.addEventListener('click', () => {
                let selectedType = elements.textTypeSelect.value;
                
                if (selectedType === 'outro') {
                    const otherType = elements.otherTypeInput.value.trim();
                    if (!otherType) {
                        alert("Por favor, especifique o tipo de texto.");
                        return;
                    }
                    appState.textType = otherType;
                } else {
                    const typeNames = {
                        'jornalistico': 'Jornal√≠stico',
                        'academico': 'Acad√™mico/Cient√≠fico',
                        'criativo': 'Criativo/Liter√°rio',
                        'tecnico': 'T√©cnico/Profissional',
                        'comercial': 'Comercial/Marketing',
                        'informal': 'Informal/Blog'
                    };
                    appState.textType = typeNames[selectedType] || selectedType;
                }
                
                updateStepDisplay(3);
                performInitialAnalysis();
            });
            
            elements.btnContinueFeedback.addEventListener('click', () => {
                appState.userFeedback = elements.userFeedback.value.trim();
                updateStepDisplay(4);
                identifyWeaknesses();
            });
            
            elements.btnGenerateSuggestions.addEventListener('click', () => {
                generateSuggestions();
            });
            
            elements.btnProceedRanking.addEventListener('click', () => {
                updateStepDisplay(5);
                rankModelResponses();
            });
            
            elements.btnSelectBest.addEventListener('click', () => {
                if (appState.ranking.length > 0) {
                    const bestModelId = appState.ranking[0].id;
                    appState.finalText = appState.modelResponses[bestModelId].content;
                    elements.finalText.textContent = appState.finalText;
                    elements.completionMessage.classList.remove('hidden');
                }
            });
            
            elements.btnSelectCombined.addEventListener('click', () => {
                appState.finalText = appState.combinedResponse;
                elements.finalText.textContent = appState.finalText;
                elements.completionMessage.classList.remove('hidden');
            });
            
            elements.btnKeepOriginal.addEventListener('click', () => {
                appState.finalText = appState.originalText;
                elements.finalText.textContent = appState.finalText;
                elements.completionMessage.classList.remove('hidden');
            });
            
            elements.btnRegenerate.addEventListener('click', () => {
                updateStepDisplay(3);
            });
            
            elements.btnCopyFinal.addEventListener('click', () => {
                navigator.clipboard.writeText(appState.finalText)
                    .then(() => alert("‚úì Texto copiado para a √°rea de transfer√™ncia!"))
                    .catch(err => {
                        console.error("Erro ao copiar texto:", err);
                        alert("N√£o foi poss√≠vel copiar o texto. Por favor, selecione-o manualmente e use Ctrl+C.");
                    });
            });
            
            elements.btnNewImprovement.addEventListener('click', () => {
                updateStepDisplay(3);
            });
            
            elements.btnStartOver.addEventListener('click', () => {
                appState.originalText = '';
                appState.textType = '';
                appState.analysisStrengths = [];
                appState.analysisSummary = '';
                appState.userFeedback = '';
                appState.textWeaknesses = [];
                appState.improvementPrompt = '';
                Object.keys(appState.modelResponses).forEach(key => {
                    appState.modelResponses[key] = { content: '', score: 0, status: 'pending' };
                });
                appState.combinedResponse = '';
                appState.ranking = [];
                appState.finalText = '';
                
                elements.textInput.value = '';
                elements.userFeedback.value = '';
                elements.completionMessage.classList.add('hidden');
                
                updateStepDisplay(1);
            });
        });
    </script>
</body>
</html>
